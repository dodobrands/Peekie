name: Release

on:
  push:
    tags:
      - "*.*.*"

env:
  PRODUCT_NAME: peekie

jobs:
  release:
    runs-on: 'macos-latest'

    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v6

    - name: Read Xcode version
      id: xcode-version
      run: echo "version=$(<.xcode-version)" >> $GITHUB_OUTPUT

    - name: Select Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ steps.xcode-version.outputs.version }}

    - name: Build release binary
      run: swift build -c release --product "$PRODUCT_NAME"

    - name: Package binary
      run: |
        BINARY_PATH=$(swift build -c release --product "$PRODUCT_NAME" --show-bin-path)/$PRODUCT_NAME
        TAG_NAME=${GITHUB_REF#refs/tags/}
        ARCHIVE_NAME="${PRODUCT_NAME}_${TAG_NAME}_darwin_arm64.tar.gz"
        tar -czf "${ARCHIVE_NAME}" -C "$(dirname "${BINARY_PATH}")" "$PRODUCT_NAME"
        echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: ${{ env.ARCHIVE_NAME }}
